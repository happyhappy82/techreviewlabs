name: Auto Release

on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            echo "reviews=$(git diff-tree --no-commit-id --name-only -r HEAD | grep 'content/reviews/' | wc -l)" >> $GITHUB_OUTPUT
          else
            echo "reviews=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep 'content/reviews/' | wc -l)" >> $GITHUB_OUTPUT
          fi

      - name: Create release notes
        if: steps.changed-files.outputs.reviews > 0
        uses: actions/github-script@v7
        with:
          script: |
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              per_page: 10
            });

            const reviewCommits = commits.filter(c =>
              c.commit.message.toLowerCase().includes('review') ||
              c.commit.message.toLowerCase().includes('add')
            );

            let body = '## ğŸ†• ìƒˆë¡œìš´ ë¦¬ë·° ì¶”ê°€\n\n';
            body += `ğŸ“ ${reviewCommits.length}ê°œì˜ ìƒˆë¡œìš´ ë¦¬ë·°ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n`;

            reviewCommits.forEach(commit => {
              body += `- ${commit.commit.message.split('\n')[0]}\n`;
            });

            body += '\nğŸš€ ë°°í¬: https://techreviewlabs.xyz';

            console.log('Release notes:', body);
