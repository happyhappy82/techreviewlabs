name: Review Content Validation

on:
  pull_request:
    paths:
      - 'content/reviews/**/*.md'

jobs:
  validate-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: |
          npm install -g js-yaml
          npm install gray-matter

      - name: Validate review frontmatter
        run: |
          cat << 'EOF' > validate.js
          const fs = require('fs');
          const matter = require('gray-matter');
          const { execSync } = require('child_process');

          // Get changed files
          const changedFiles = execSync('git diff --name-only origin/main HEAD')
            .toString()
            .split('\n')
            .filter(file => file.startsWith('content/reviews/') && file.endsWith('.md'));

          let hasErrors = false;

          changedFiles.forEach(file => {
            if (!fs.existsSync(file)) return;

            console.log(`\n✅ Validating: ${file}`);

            const content = fs.readFileSync(file, 'utf8');
            const { data } = matter(content);

            // Required fields
            const required = ['title', 'date', 'excerpt', 'category', 'rating', 'product'];
            const missing = required.filter(field => !data[field]);

            if (missing.length > 0) {
              console.error(`❌ Missing required fields: ${missing.join(', ')}`);
              hasErrors = true;
            }

            // Validate rating (0-5)
            if (data.rating && (data.rating < 0 || data.rating > 5)) {
              console.error(`❌ Rating must be between 0 and 5 (got ${data.rating})`);
              hasErrors = true;
            }

            // Validate date format (YYYY-MM-DD)
            if (data.date && !/^\d{4}-\d{2}-\d{2}$/.test(data.date)) {
              console.error(`❌ Date must be in YYYY-MM-DD format (got ${data.date})`);
              hasErrors = true;
            }

            // Valid categories
            const validCategories = ['스마트폰', '노트북', '태블릿', '이어폰', '스마트워치', '카메라', '기타'];
            if (data.category && !validCategories.includes(data.category)) {
              console.warn(`⚠️  Unusual category: ${data.category}`);
            }

            if (!hasErrors) {
              console.log(`✅ ${file} validation passed!`);
            }
          });

          if (hasErrors) {
            process.exit(1);
          }
          EOF

          node validate.js

      - name: Comment validation results
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ❌ Review Validation Failed\n\nPlease check the required frontmatter fields:\n- title\n- date (YYYY-MM-DD)\n- excerpt\n- category\n- rating (0-5)\n- product'
            })
