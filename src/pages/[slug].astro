---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import TableOfContents from '../components/TableOfContents.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const reviews = await getCollection('reviews');
  return reviews.map((review) => ({
    params: { slug: review.slug },
    props: { review },
  }));
}

const { review } = Astro.props;
const { Content } = await review.render();

function formatDateForDisplay(date: string): string {
  if (!date) return '';
  return date.split('T')[0];
}

function getReadingTime(content: string): string {
  const wordsPerMinute = 200;
  const words = content.trim().split(/\s+/).length;
  const minutes = Math.ceil(words / wordsPerMinute);
  return `${minutes} min read`;
}

const pageUrl = `https://www.techreviewlab.xyz/${review.slug}`;
const isActualReview = review.data.product && (review.data.rating ?? 0) > 0;

const mainSchema = isActualReview
  ? {
      "@context": "https://schema.org",
      "@type": "Review",
      itemReviewed: {
        "@type": "Product",
        name: review.data.product,
        category: review.data.category,
      },
      reviewRating: {
        "@type": "Rating",
        ratingValue: review.data.rating,
        bestRating: 5,
        worstRating: 1,
      },
      author: {
        "@type": "Organization",
        name: "TechReviewLabs",
        url: "https://www.techreviewlab.xyz",
      },
      publisher: {
        "@type": "Organization",
        name: "TechReviewLabs",
        url: "https://www.techreviewlab.xyz",
        logo: {
          "@type": "ImageObject",
          url: "https://www.techreviewlab.xyz/logo.png",
        },
      },
      datePublished: review.data.date,
      dateModified: review.data.date,
      reviewBody: review.data.excerpt,
      mainEntityOfPage: {
        "@type": "WebPage",
        "@id": pageUrl,
      },
      image: "https://www.techreviewlab.xyz/opengraph-image.png",
    }
  : {
      "@context": "https://schema.org",
      "@type": "Article",
      headline: review.data.title,
      description: review.data.excerpt,
      datePublished: review.data.date,
      dateModified: review.data.date,
      author: {
        "@type": "Organization",
        name: "TechReviewLabs",
        url: "https://www.techreviewlab.xyz",
      },
      publisher: {
        "@type": "Organization",
        name: "TechReviewLabs",
        url: "https://www.techreviewlab.xyz",
        logo: {
          "@type": "ImageObject",
          url: "https://www.techreviewlab.xyz/logo.png",
        },
      },
      mainEntityOfPage: {
        "@type": "WebPage",
        "@id": pageUrl,
      },
      image: "https://www.techreviewlab.xyz/opengraph-image.png",
    };

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "홈",
      item: "https://www.techreviewlab.xyz",
    },
    {
      "@type": "ListItem",
      position: 2,
      name: review.data.title,
      item: pageUrl,
    },
  ],
};
---

<BaseLayout
  title={review.data.title}
  description={review.data.excerpt}
  canonical={pageUrl}
  ogType="article"
  publishedTime={review.data.date}
  modifiedTime={review.data.date}
>
  <Header />
  <main class="flex gap-8">
    <!-- 메인 콘텐츠 영역 -->
    <article class="flex-1 min-w-0">
      <script type="application/ld+json" set:html={JSON.stringify(mainSchema)} />
      <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

      <!-- 헤더 섹션 -->
      <div class="mb-8 pb-6 border-b border-ns-border">
        <div class="flex items-center gap-3 mb-4">
          <span class="ns-number-badge">1</span>
          <span class="ns-badge">{review.data.category}</span>
        </div>
        <h1 class="text-ns-title text-ns-text mb-4">
          {review.data.title}
        </h1>
        <div class="flex items-center gap-4 text-[13px] text-gray-500">
          <div class="flex items-center gap-2">
            <div class="w-6 h-6 rounded-full bg-ns-bg flex items-center justify-center">
              <span class="text-[10px] font-bold">TRL</span>
            </div>
            <span class="font-medium text-ns-text">TechReviewLabs</span>
          </div>
          <time datetime={review.data.date} class="text-gray-500">
            {formatDateForDisplay(review.data.date)} 업데이트
          </time>
        </div>
      </div>

      <!-- 요약 박스 (excerpt) -->
      <div class="ns-card mb-8 bg-ns-bg">
        <p class="text-[14px] text-ns-text leading-relaxed">
          {review.data.excerpt}
        </p>
      </div>

      <!-- 본문 콘텐츠 -->
      <div class="prose prose-lg max-w-none">
        <Content />
      </div>
    </article>

    <!-- 사이드바 -->
    <aside class="hidden lg:block w-[200px] flex-shrink-0">
      <TableOfContents />
    </aside>
  </main>
</BaseLayout>

<style>
  /* 본문 너비 */
  article .prose {
    max-width: 800px;
  }

  /* 노서치 스타일 prose */
  article .prose h2 {
    scroll-margin-top: 5rem;
    font-size: 22px;
    font-weight: 800;
    color: #1A1A1A;
    margin-top: 3rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #1A1A1A;
  }

  article .prose h3 {
    scroll-margin-top: 5rem;
    font-size: 18px;
    font-weight: 700;
    color: #1A1A1A;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  article .prose p {
    font-size: 15px;
    line-height: 1.8;
    color: #1A1A1A;
    margin-bottom: 1rem;
  }

  article .prose ul, article .prose ol {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }

  article .prose li {
    font-size: 15px;
    line-height: 1.8;
    margin-bottom: 0.5rem;
  }

  article .prose strong {
    font-weight: 700;
    color: #1A1A1A;
  }

  /* 테이블 스타일 - 노서치 */
  article .prose table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border: 1px solid #DFDFDF;
    border-radius: 10px;
    overflow: hidden;
    margin: 1.5rem 0;
    font-size: 14px;
  }

  article .prose th {
    background: #F9F9F9;
    font-weight: 700;
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid #DFDFDF;
    color: #1A1A1A;
  }

  article .prose td {
    padding: 12px 16px;
    border-bottom: 1px solid #DFDFDF;
    color: #1A1A1A;
  }

  article .prose tr:last-child td {
    border-bottom: none;
  }

  /* FAQ 토글 스타일 - 노서치 */
  article .prose details {
    border: 1px solid #DFDFDF;
    border-radius: 10px;
    padding: 0;
    margin: 1rem 0;
    background: #fff;
  }

  article .prose details summary {
    padding: 1rem 1.25rem;
    cursor: pointer;
    font-weight: 700;
    font-size: 14px;
    list-style: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #1A1A1A;
  }

  article .prose details summary::-webkit-details-marker {
    display: none;
  }

  article .prose details summary::before {
    content: '▶';
    font-size: 0.6rem;
    transition: transform 0.2s;
    color: #1A1A1A;
  }

  article .prose details[open] summary::before {
    transform: rotate(90deg);
  }

  article .prose details[open] summary {
    border-bottom: 1px solid #DFDFDF;
    background: #F9F9F9;
  }

  article .prose details > *:not(summary) {
    padding: 0 1.25rem;
  }

  article .prose details > *:last-child {
    padding-bottom: 1rem;
  }

  /* 링크 스타일 */
  article .prose a {
    color: #256FFF;
    text-decoration: underline;
    font-weight: 500;
  }

  article .prose a:hover {
    color: #1a4fc9;
  }

  /* 코드 스타일 */
  article .prose code {
    background: #F9F9F9;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 13px;
    color: #1A1A1A;
  }

  article .prose pre {
    background: #F9F9F9;
    border: 1px solid #DFDFDF;
    border-radius: 10px;
    padding: 1rem;
    overflow-x: auto;
  }

  article .prose pre code {
    background: none;
    padding: 0;
  }

  /* 인용구 */
  article .prose blockquote {
    border-left: 4px solid #256FFF;
    padding-left: 1rem;
    margin: 1.5rem 0;
    color: #1F1F1F;
    font-style: normal;
  }
</style>
