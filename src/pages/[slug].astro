---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const reviews = await getCollection('reviews');
  return reviews.map((review) => ({
    params: { slug: review.slug },
    props: { review },
  }));
}

const { review } = Astro.props;
const { Content } = await review.render();

function formatDateForDisplay(date: string): string {
  if (!date) return '';
  return date.split('T')[0];
}

function getReadingTime(content: string): string {
  const wordsPerMinute = 200;
  const words = content.trim().split(/\s+/).length;
  const minutes = Math.ceil(words / wordsPerMinute);
  return `${minutes} min read`;
}

const pageUrl = `https://www.techreviewlab.xyz/${review.slug}`;
const isActualReview = review.data.product && (review.data.rating ?? 0) > 0;

const mainSchema = isActualReview
  ? {
      "@context": "https://schema.org",
      "@type": "Review",
      itemReviewed: {
        "@type": "Product",
        name: review.data.product,
        category: review.data.category,
      },
      reviewRating: {
        "@type": "Rating",
        ratingValue: review.data.rating,
        bestRating: 5,
        worstRating: 1,
      },
      author: {
        "@type": "Organization",
        name: "TechReviewLabs",
        url: "https://www.techreviewlab.xyz",
      },
      publisher: {
        "@type": "Organization",
        name: "TechReviewLabs",
        url: "https://www.techreviewlab.xyz",
        logo: {
          "@type": "ImageObject",
          url: "https://www.techreviewlab.xyz/logo.png",
        },
      },
      datePublished: review.data.date,
      dateModified: review.data.date,
      reviewBody: review.data.excerpt,
      mainEntityOfPage: {
        "@type": "WebPage",
        "@id": pageUrl,
      },
      image: "https://www.techreviewlab.xyz/opengraph-image.png",
    }
  : {
      "@context": "https://schema.org",
      "@type": "Article",
      headline: review.data.title,
      description: review.data.excerpt,
      datePublished: review.data.date,
      dateModified: review.data.date,
      author: {
        "@type": "Organization",
        name: "TechReviewLabs",
        url: "https://www.techreviewlab.xyz",
      },
      publisher: {
        "@type": "Organization",
        name: "TechReviewLabs",
        url: "https://www.techreviewlab.xyz",
        logo: {
          "@type": "ImageObject",
          url: "https://www.techreviewlab.xyz/logo.png",
        },
      },
      mainEntityOfPage: {
        "@type": "WebPage",
        "@id": pageUrl,
      },
      image: "https://www.techreviewlab.xyz/opengraph-image.png",
    };

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "í™ˆ",
      item: "https://www.techreviewlab.xyz",
    },
    {
      "@type": "ListItem",
      position: 2,
      name: review.data.title,
      item: pageUrl,
    },
  ],
};
---

<BaseLayout
  title={review.data.title}
  description={review.data.excerpt}
  canonical={pageUrl}
  ogType="article"
  publishedTime={review.data.date}
  modifiedTime={review.data.date}
>
  <Header />
  <main>
    <article class="relative">
      <script type="application/ld+json" set:html={JSON.stringify(mainSchema)} />
      <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

      <div class="mb-8">
        <h1
          class="text-[42px] font-black leading-tight mb-4"
          style={`color: ${review.data.lightColor}`}
        >
          {review.data.title}
        </h1>
        <div class="flex gap-4 text-sm text-gray-600">
          <time datetime={review.data.date}>{formatDateForDisplay(review.data.date)}</time>
          <span>{getReadingTime(review.body)}</span>
        </div>
      </div>

      <div class="prose prose-lg max-w-none">
        <Content />
      </div>
    </article>
  </main>
</BaseLayout>

<style>
  .prose h2 {
    scroll-margin-top: 5rem;
  }
  .prose h3 {
    scroll-margin-top: 5rem;
  }
</style>
